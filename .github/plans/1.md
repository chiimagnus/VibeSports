# 加载带跑步动画的 3D 角色模型（单个 Runner.usdz + 多段动画）

## 目标

把底部的 emoji 小人替换为 SceneKit 中的 3D 跑步角色，动画速度与用户实际运动速度绑定，并把视角从第一人称改为第三人称。

本方案 **不做向后兼容**：直接以 `Runner.usdz` 为唯一角色资源，后续逻辑都以“单资源 + 多动画 clip”的方式组织。

## 资源产物（重要）

### 源素材（不进 App Bundle）

本地保留 3 个“同一角色、同一骨骼”的 USDZ（each with skin + skeleton + one animation）：

- `Idle.usdz`
- `Slow Run.usdz`
- `Fast Run.usdz`

它们只用于构建产物（`Runner.usdz`），不建议放进 Xcode target 的 Copy Bundle Resources。

### App 内最终使用的资源（进 App Bundle）

只保留 1 个：`VibeSports/Resources/Runner.usdz`

这个 `Runner.usdz` 包含：

- **1 份 mesh + skin + 材质**（来自 `Idle`）
- **3 段可独立取用的骨骼动画 clip**（`Idle / SlowRun / FastRun`）
- Slow/Fast 的 mesh/skin 已在打包阶段裁剪掉（只保留动画层），避免“3 份 skin 数据”的体积浪费

## Step 1：构建 Runner.usdz（裁剪掉 slow/fast 的多余 skin）

用脚本把 3 个源 USDZ 合成并裁剪：

```bash
bash scripts/build_runner_usdz.sh \
  --idle "/path/to/Idle.usdz" \
  --slow "/path/to/Slow Run.usdz" \
  --fast "/path/to/Fast Run.usdz" \
  --out  "VibeSports/Resources/Runner.usdz"
```

可选：`--default idle|slow|fast` 用来控制 Quick Look 默认播放哪条动画（仅用于预览，不影响 SceneKit 按 key 取动画）。

## Step 2：验证 Runner.usdz 是否真的包含多段动画

### 2.1 用 Debug Window 验证（推荐）

在 App 里打开：`Debug -> Runner Animations…`（窗口由 `RunnerAnimationDebugView` 提供）。

预期：能看到 3 个 `animationKeys`，并可 Play/Solo/调 `blendFactor`。

### 2.2 用代码验证（备选）

```swift
let scene = try! SCNScene(url: Bundle.main.url(forResource: "Runner", withExtension: "usdz")!)
let skeleton = scene.rootNode.childNode(withName: "Skeleton", recursively: true)!
print(skeleton.animationKeys)
```

预期 key（名称可能带完整路径）：

- `/Runner/mixamorig_Hips/Skeleton/Idle`
- `/Runner/mixamorig_Hips/Skeleton/SlowRun`
- `/Runner/mixamorig_Hips/Skeleton/FastRun`

## Step 3：把角色加载到 RunnerSceneRenderer 的 SceneKit 场景中

### 文件位置

主要改动在 `VibeSports/Services/Renderer/RunnerSceneRenderer.swift`

### 关键点

- **不要用 `rootNode.childNodes.first!` 猜节点**：USDZ 顶层经常有包装节点
- 更稳的办法：
  - 先找带 `skinner != nil` 的节点作为渲染用 `runnerNode`
  - 再找命名为 `Skeleton` 的节点作为动画挂载点（`skeletonNode`）

## Step 4：三动画同时播放 + 速度连续混合

### 动画挂载点

`Runner.usdz` 的动画 key 通常挂在 `Skeleton` 节点上（而不是 mesh 节点）。

### 混合策略（连续）

三个动画（idle/slow/fast）同时 `play()`，通过 `SCNAnimationPlayer.blendFactor` 控制权重：

- `speed < idleThreshold`：纯 idle
- `idleThreshold ..< minRunSpeed`：idle -> slow 线性过渡
- `minRunSpeed ..< maxRunSpeed`：slow -> fast 线性过渡

并用 `SCNAnimationPlayer.speed` 让步频随真实速度变化（例如 clamp 到 `0.3...3.0`）。

## Step 5：第三人称相机（跟随角色，而不是“相机本体向前飞”）

当前实现是“相机向前推进 + bob/sway”；第三人称推荐改成：

- 用一个 `travelZ` 表示世界推进（只影响跑道循环与角色 Z）
- `runnerNode.position.z = travelZ + runnerAheadOffset`
- `cameraNode.position = runnerNode.position + cameraOffset`
- bob/sway 只加在相机局部 offset 上（别叠进 travelZ）

## Step 6：移除旧的 RunnerAvatarView（emoji 小人）

当 3D 角色在场景里跑起来后：

- 删除 `RunnerGameView` 中对 `RunnerAvatarView` 的引用
- `RunnerAvatarView.swift` 可删除或留作备选

## 调试 Tips

- Quick Look 只能播“默认动画”，不能用它判断“是否只有一段动画”
- 以 Debug Window / 代码打印 `Skeleton.animationKeys` 为准
- 模型大小/朝向：优先在 DCC（或导出）阶段统一；运行时只做必要的 scale/rotation
