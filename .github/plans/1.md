# åŠ è½½å¸¦è·‘æ­¥åŠ¨ç”»çš„ 3D è§’è‰²æ¨¡å‹

## ç›®æ ‡

æŠŠåº•éƒ¨çš„ emoji å°äººæ›¿æ¢ä¸º SceneKit ä¸­çš„ 3D è·‘æ­¥è§’è‰²ï¼ŒåŠ¨ç”»é€Ÿåº¦ä¸ç”¨æˆ·å®é™…è¿åŠ¨é€Ÿåº¦ç»‘å®šï¼Œè§†è§’ä»ç¬¬ä¸€äººç§°æ”¹ä¸ºç¬¬ä¸‰äººç§°ã€‚

### äº§å‡º

é¡¹ç›®ä¸­å¤šå‡ºä¸‰ä¸ª USDZ æ–‡ä»¶ï¼ˆåŒä¸€è§’è‰²ï¼Œä¸åŒåŠ¨ç”»ï¼Œå‡ä¸º With Skinï¼‰ï¼š

- `Slow Run.usdz` â€” æ…¢è·‘åŠ¨ç”»ï¼ˆä¸»æ¨¡å‹ï¼Œæä¾› mesh + éª¨éª¼ï¼‰
- `Fast Run.usdz` â€” å¿«è·‘åŠ¨ç”»
- `Idle.usdz` â€” å¾…æœºåŠ¨ç”»ï¼ˆç”¨æˆ·åœæ­¢è¿åŠ¨æ—¶æ’­æ”¾ï¼‰

## Step 2ï¼šæŠŠè§’è‰²åŠ è½½åˆ° SceneKit åœºæ™¯ä¸­

### æ–‡ä»¶ä½ç½®

ä¸»è¦æ”¹åŠ¨åœ¨ `VibeSports/Services/Renderer/RunnerSceneRenderer.swift`

### ä»£ç æ€è·¯

```swift
// 1. åŠ è½½æ¨¡å‹
let runnerScene = SCNScene(named: "runner.usdz")!
let runnerNode = runnerScene.rootNode.childNodes.first!
runnerNode.name = "runner"

// 2. è°ƒæ•´ç¼©æ”¾å’Œä½ç½®ï¼ˆæ•°å€¼éœ€è¦æ ¹æ®å®é™…æ¨¡å‹è°ƒè¯•ï¼‰
runnerNode.scale = SCNVector3(0.01, 0.01, 0.01) // Mixamo æ¨¡å‹é€šå¸¸å¾ˆå¤§ï¼Œéœ€è¦ç¼©å°
runnerNode.position = SCNVector3(0, 0, -5)       // æ”¾åœ¨ç›¸æœºå‰æ–¹

// 3. æ·»åŠ åˆ°åœºæ™¯
scene.rootNode.addChildNode(runnerNode)
```

---

## Step 3ï¼šæ’­æ”¾åŠ¨ç”» + é€Ÿåº¦æ··åˆï¼ˆAnimation Blendingï¼‰

### æ ¸å¿ƒæ€è·¯

ä¸‰ä¸ªåŠ¨ç”»ï¼ˆidleã€slow-runã€fast-runï¼‰åŒæ—¶åŠ è½½åˆ°è§’è‰²ä¸Šï¼Œé€šè¿‡ `blendFactor` æ§åˆ¶æ··åˆæ¯”ä¾‹ï¼Œè®©è§’è‰²åœ¨ä¸åŒé€Ÿåº¦ä¸‹è‡ªç„¶è¿‡æ¸¡å§¿æ€ã€‚

| ç”¨æˆ·é€Ÿåº¦ | idle | slow | fast |
| --- | --- | --- | --- |
| é™æ­¢ï¼ˆ<0.1 m/sï¼‰ | 100% | 0% | 0% |
| å¾ˆæ…¢ï¼ˆ~0.5 m/sï¼‰ | 0% | 100% | 0% |
| ä¸­ç­‰ï¼ˆ~2.0 m/sï¼‰ | 0% | 50% | 50% |
| å¾ˆå¿«ï¼ˆ>4.0 m/sï¼‰ | 0% | 0% | 100% |

### 3.1 é€’å½’æŸ¥æ‰¾åŠ¨ç”»çš„å·¥å…·å‡½æ•°

Mixamo å¯¼å‡ºçš„æ¨¡å‹ï¼ŒåŠ¨ç”»ç»å¸¸æŒ‚åœ¨å­èŠ‚ç‚¹ä¸Šï¼Œéœ€è¦é€’å½’æœç´¢ï¼š

```swift
/// é€’å½’æ”¶é›†èŠ‚ç‚¹æ ‘ä¸­æ‰€æœ‰åŠ¨ç”»
func extractAnimations(from node: SCNNode) -> [(String, SCNAnimationPlayer)] {
    var result: [(String, SCNAnimationPlayer)] = []
    for key in node.animationKeys {
        if let player = node.animationPlayer(forKey: key) {
            result.append((key, player))
        }
    }
    for child in node.childNodes {
        result += extractAnimations(from: child)
    }
    return result
}
```

### 3.2 ä»ä¸‰ä¸ª USDZ åŠ è½½åŠ¨ç”»åˆ°åŒä¸€ä¸ªè§’è‰²

ç”¨ `Slow Run.usdz` ä½œä¸ºä¸»æ¨¡å‹ï¼ˆæä¾› meshï¼‰ï¼Œä»å¦å¤–ä¸¤ä¸ªæ–‡ä»¶æå–åŠ¨ç”»æŒ‚ä¸Šå»ï¼š

```swift
// ä¸»è§’è‰²ï¼ˆç”¨ Slow Run.usdz æä¾› mesh + éª¨éª¼ï¼‰
let mainScene = SCNScene(named: "Slow Run.usdz")!
let runnerNode = mainScene.rootNode.childNodes.first!

// ç»™ä¸»è§’è‰²è‡ªå¸¦çš„åŠ¨ç”»é‡å‘½åä¸º "slow-run"
let slowAnims = extractAnimations(from: runnerNode)
for (originalKey, player) in slowAnims {
    runnerNode.removeAnimationPlayer(forKey: originalKey)
    runnerNode.addAnimationPlayer(player, forKey: "slow-run")
}

// ä» Fast Run.usdz æå– fast åŠ¨ç”»
let fastScene = SCNScene(named: "Fast Run.usdz")!
let fastSourceNode = fastScene.rootNode.childNodes.first!
let fastAnims = extractAnimations(from: fastSourceNode)
for (_, player) in fastAnims {
    runnerNode.addAnimationPlayer(player, forKey: "fast-run")
}

// ä» Idle.usdz æå– idle åŠ¨ç”»
let idleScene = SCNScene(named: "Idle.usdz")!
let idleSourceNode = idleScene.rootNode.childNodes.first!
let idleAnims = extractAnimations(from: idleSourceNode)
for (_, player) in idleAnims {
    runnerNode.addAnimationPlayer(player, forKey: "idle")
}

// åŒæ—¶æ’­æ”¾ä¸‰ä¸ªåŠ¨ç”»
runnerNode.animationPlayer(forKey: "idle")?.play()
runnerNode.animationPlayer(forKey: "slow-run")?.play()
runnerNode.animationPlayer(forKey: "fast-run")?.play()
```

<aside>
âš ï¸

**ä¸‰ä¸ª USDZ å¿…é¡»ç”¨åŒä¸€ä¸ª Mixamo è§’è‰²**ï¼ˆæ¯”å¦‚éƒ½æ˜¯ Y Botï¼‰ï¼Œéª¨éª¼ç»“æ„è¦ä¸€è‡´ï¼Œå¦åˆ™æ··åˆä¼šå‡ºé—®é¢˜ã€‚

</aside>

### 3.3 æ ¹æ®é€Ÿåº¦æ§åˆ¶ä¸‰ä¸ªåŠ¨ç”»çš„æ··åˆæ¯”ä¾‹

åœ¨ `setSpeedMetersPerSecond(_:)` ä¸­åŠ å…¥æ··åˆé€»è¾‘ï¼š

```swift
func setSpeedMetersPerSecond(_ speed: Double) {
    // ç°æœ‰çš„åœºæ™¯æ¨è¿›é€»è¾‘...
    
    // ---- åŠ¨ç”»æ··åˆ ----
    let idlePlayer = runnerNode.animationPlayer(forKey: "idle")
    let slowPlayer = runnerNode.animationPlayer(forKey: "slow-run")
    let fastPlayer = runnerNode.animationPlayer(forKey: "fast-run")
    
    // å®šä¹‰é€Ÿåº¦åŒºé—´
    let idleThreshold: Double = 0.1  // ä½äºæ­¤ â†’ çº¯ idle
    let minRunSpeed: Double = 0.5    // idle â†’ slow è¿‡æ¸¡å®Œæˆ
    let maxRunSpeed: Double = 4.0    // slow â†’ fast è¿‡æ¸¡å®Œæˆ
    
    if speed < idleThreshold {
        // é™æ­¢ â†’ çº¯ idle
        idlePlayer?.blendFactor = 1.0
        slowPlayer?.blendFactor = 0.0
        fastPlayer?.blendFactor = 0.0
        idlePlayer?.speed = 1.0
        return
    }
    
    if speed < minRunSpeed {
        // idle â†’ slow è¿‡æ¸¡åŒºé—´
        let t = CGFloat((speed - idleThreshold) / (minRunSpeed - idleThreshold))
        idlePlayer?.blendFactor = 1.0 - t
        slowPlayer?.blendFactor = t
        fastPlayer?.blendFactor = 0.0
    } else {
        // slow â†’ fast æ··åˆåŒºé—´
        let t = CGFloat(((speed - minRunSpeed) / (maxRunSpeed - minRunSpeed))
            .clamped(to: 0.0...1.0))
        idlePlayer?.blendFactor = 0.0
        slowPlayer?.blendFactor = 1.0 - t
        fastPlayer?.blendFactor = t
    }
    
    // è°ƒæ•´è·‘æ­¥åŠ¨ç”»æ’­æ”¾é€Ÿç‡ï¼Œè®©æ­¥é¢‘åŒ¹é…å®é™…é€Ÿåº¦
    let baseSpeed: Double = 2.0
    let playbackRate = CGFloat(speed / baseSpeed).clamped(to: 0.3...3.0)
    slowPlayer?.speed = playbackRate
    fastPlayer?.speed = playbackRate
}
```

---

## Step 4ï¼šè°ƒæ•´ç›¸æœºä¸ºç¬¬ä¸‰äººç§°è§†è§’

ç°åœ¨çš„ç›¸æœºæ˜¯ç¬¬ä¸€äººç§°å¾€å‰çœ‹ï¼ŒåŠ äº†è§’è‰²åæ”¹æˆç¬¬ä¸‰äººç§°è·Ÿéšï¼š

```swift
// ç›¸æœºåœ¨è§’è‰²åä¸Šæ–¹
let cameraOffset = SCNVector3(0, 2.5, 5) // åæ–¹ 5 ç±³ï¼Œä¸Šæ–¹ 2.5 ç±³

// æ¯å¸§æ›´æ–°ç›¸æœºä½ç½®ï¼ˆåœ¨ renderer(_:updateAtTime:) ä¸­ï¼‰
cameraNode.position = SCNVector3(
    runnerNode.position.x + cameraOffset.x,
    runnerNode.position.y + cameraOffset.y,
    runnerNode.position.z + cameraOffset.z
)
cameraNode.look(at: runnerNode.position)
```

> ğŸ’¡ ä¹Ÿå¯ä»¥ç”¨ `SCNLookAtConstraint` è®©ç›¸æœºè‡ªåŠ¨æœå‘è§’è‰²ï¼Œæ›´ç®€æ´ã€‚
> 

---

## Step 5ï¼šæ¸…ç†æ—§çš„ RunnerAvatarView

è§’è‰²å·²ç»åœ¨ 3D åœºæ™¯é‡Œäº†ï¼Œåº•éƒ¨çš„ `RunnerAvatarView`ï¼ˆemoji å°äººï¼‰å¯ä»¥ç§»é™¤ï¼š

- åˆ é™¤ `RunnerGameView` ä¸­å¯¹ `RunnerAvatarView` çš„å¼•ç”¨
- `RunnerAvatarView.swift` æ–‡ä»¶å¯ä»¥ä¿ç•™æˆ–åˆ é™¤ï¼Œçœ‹ä½ å¿ƒæƒ…

---

## è°ƒè¯• Tips

- **æ¨¡å‹å¤ªå¤§/å¤ªå°**ï¼šè°ƒ `runnerNode.scale`ï¼ŒMixamo æ¨¡å‹é€šå¸¸éœ€è¦ç¼©å° 100 å€å·¦å³
- **æ¨¡å‹æ–¹å‘ä¸å¯¹**ï¼šè°ƒ `runnerNode.eulerAngles.y`ï¼ˆæ—‹è½¬ Y è½´ï¼‰
- **åŠ¨ç”»ä¸æ’­æ”¾**ï¼šç”¨ `print(runnerNode.animationKeys)` æ£€æŸ¥åŠ¨ç”»æ˜¯å¦æ­£ç¡®åŠ è½½ï¼Œæ³¨æ„åŠ¨ç”»å¯èƒ½æŒ‚åœ¨å­èŠ‚ç‚¹ä¸Š
- **æ€§èƒ½**ï¼šå¼€ Xcode çš„ SceneKit Statisticsï¼ˆ`scnView.showsStatistics = true`ï¼‰çœ‹å¸§ç‡å’Œé¢æ•°

---

## é¢„æœŸæ•ˆæœ

- ç”¨æˆ·çœ‹åˆ°ï¼š3D è·‘é“ + ä¸€ä¸ªå°äººåœ¨å‰æ–¹å¥”è·‘ + å³ä¸Šè§’æ‘„åƒå¤´ç”»é¢
- ç”¨æˆ·è·‘å¾—å¿« â†’ å°äººè·‘å¾—å¿« â†’ è·‘é“æ¨è¿›å¿«
- ç”¨æˆ·åœä¸‹ â†’ å°äººè‡ªç„¶è¿‡æ¸¡åˆ° idle å¾…æœºå§¿æ€